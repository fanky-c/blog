<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <!--  禁止百度引擎抓取 -->
    <meta name="Baiduspider" content="noarchive">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="js、nodejs、css、nginx、vue、react">
    <meta name="keyword" content="网易">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        vue源码分析上 - fanky_c的博客 | fanky_c&#39;s Blog
        
    </title>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/aircloud.css">
    <link rel="stylesheet" href="/css/gitment.css">
    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i>  </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>fanky_c</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#概论"><span class="toc-text">概论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vue的核心可以分为四个大块"><span class="toc-text">vue的核心可以分为四个大块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vue的源码目录"><span class="toc-text">vue的源码目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#模板编译代码解读"><span class="toc-text">模板编译代码解读</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#a，生成AST"><span class="toc-text">a，生成AST</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#b，优化静态内容"><span class="toc-text">b，优化静态内容</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#c，生成render字符串"><span class="toc-text">c，生成render字符串</span></a></li></ol></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>
        <div class="index-about-mobile">
            <i>  </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        vue源码分析上
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2018-07-08 21:22:55</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#vue" title="vue">vue</a>
        <span>/</span>
        
        <a class="tag" href="/tags/#模板编译" title="模板编译">模板编译</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content ">
        <h2 id="概论"><a href="#概论" class="headerlink" title="概论"></a>概论</h2><p>本文主要讲vue源码分析 – <strong>模板编译</strong></p>
<p><em>以v2.5.16版本为分析例子(<a href="https://github.com/vuejs/vue/tree/v2.5.16" target="_blank" rel="noopener">https://github.com/vuejs/vue/tree/v2.5.16</a>)</em></p>
<h3 id="vue的核心可以分为四个大块"><a href="#vue的核心可以分为四个大块" class="headerlink" title="vue的核心可以分为四个大块"></a>vue的核心可以分为四个大块</h3><ul>
<li>数据处理和双向绑定</li>
<li>模板编译</li>
<li>虚拟DOM</li>
<li>组件化</li>
</ul>
<h3 id="vue的源码目录"><a href="#vue的源码目录" class="headerlink" title="vue的源码目录"></a>vue的源码目录</h3><ul>
<li><p>circleci：是一个持续集成与部署服务。vue使用了这个服务来部署项目，该文件夹下为circleci部署所需的配置文件<br>benchmarks：这个文件夹里面，都是作者对于vue的性能测试。其中在性能测试代码中，有一个api大家可以关注下，window.performance.now()，该api经常在衡量代码运行时间，运行效率时被用到</p>
</li>
<li><p>example： 相当于vue的使用说明，里面都是尤大写的vue使用的小demo</p>
</li>
<li><p>flow: flow是一个用来进行静态类型检查的工具。它的作用是让现有的JavaScript语法可以事先作类型的声明(定义)，然后在开发过程中去进行自动检查。vue使用了该工具。该文件夹中，都是作者定义的静态类型。</p>
</li>
<li><p>test： 测试用例</p>
</li>
<li><p>src:  vue的所有重要代码，都写在了这里面。详细说一下其下的各个文件夹。</p>
<ul>
<li>compiler：模板解析模板编译的相关代码，也是本次组会要跟大家进行解读的部分</li>
<li>core <ul>
<li>components： 全局组件定义的代码</li>
<li>global-api： 添加在vue对象上的方法。比如Vue.use，Vue.enxtend等</li>
<li>instance： vue实例相关的内容，比如生命周期，事件等。</li>
<li>observer： vue双向绑定部分的代码</li>
<li>vdom： 虚拟dom相关的代码</li>
<li>util： vue的工具方法 </li>
</ul>
</li>
<li>platforms：一个是web平台，我们常用的就是这个。一个是weex平台，weex是一个用于开发原生应用的框架，也可以把它视作vue-native。  </li>
<li>server：服务端渲染的相关代码。  </li>
<li>shared： vue共享的工具和方法。        </li>
<li>sfc： .vue 文件解析 </li>
</ul>
</li>
</ul>
<h3 id="模板编译代码解读"><a href="#模板编译代码解读" class="headerlink" title="模板编译代码解读"></a>模板编译代码解读</h3><pre><code class="js"><span class="keyword">export</span> <span class="keyword">const</span> createCompiler = createCompilerCreator(<span class="function"><span class="keyword">function</span> <span class="title">baseCompile</span>(<span class="params"></span></span>
<span class="function"><span class="params">  template: string,</span></span>
<span class="function"><span class="params">  options: CompilerOptions</span></span>
<span class="function"><span class="params"></span>): <span class="title">CompiledResult</span> </span>{
  <span class="keyword">const</span> ast = parse(template.trim(), options)
  <span class="keyword">if</span> (options.optimize !== <span class="literal">false</span>) {
    optimize(ast, options)
  }
  <span class="keyword">const</span> code = generate(ast, options)
  <span class="keyword">return</span> {
    ast,
    render: code.render,
    staticRenderFns: code.staticRenderFns
  }
})
</code></pre>
<p>vue模板编译的三个重要阶段都在上面的baseCompile函数中，这三个阶段分别是：</p>
<ul>
<li>生成AST</li>
<li>优化静态内容</li>
<li>生成render。</li>
</ul>
<h4 id="a，生成AST"><a href="#a，生成AST" class="headerlink" title="a，生成AST"></a>a，生成AST</h4><p><em>AST简介</em></p>
<p>AST即抽象语法树，我们的代码运行在浏览器的时候，浏览器首先就会把我们的代码解析为AST然后再进一步把语法树转化为字节码或者直接生成机器码。所以他对于浏览器很重要，同样的对于开发者来说，AST也很重要，我们通过ast可以精准定位到代码的任何地方，从而可以对代码进行一系列操作。比如代码的语法检查，压缩以及代码结构的改变等等。webpack、UglifyJS等工具的核心都是通过ast来操作代码的。语法树记录了其对应代码的所有信息。</p>
<p><em>JavaScript Parser</em></p>
<p>代码解析成AST，是通过js Parser来实现的，不同的parser，生成的AST格式是不同的。比如chrome和firefox，由于jsParser不同，其生成的AST格式也不同，优化AST的格式有时也是浏览器厂商提高浏览器效率的一种方式。</p>
<p><a href="https://astexplorer.net/" target="_blank" rel="noopener">这个网站</a>可以即时看到不同parser解析出的ast</p>
<pre><code class="js"><span class="keyword">const</span> ast = parse(template.trim(), options)
</code></pre>
<h4 id="b，优化静态内容"><a href="#b，优化静态内容" class="headerlink" title="b，优化静态内容"></a>b，优化静态内容</h4><p>静态内容就是和数据没有关系，当数据更新时，不需要刷新的内容。比如{ { text } }就是非静态内容，当数据变化的时候，这里的内容也会被更新。<br>baseCompile函数中，通过下面这行代码实现了静态内容的优化</p>
<pre><code class="js"><span class="keyword">if</span> (options.optimize !== <span class="literal">false</span>) {
    optimize(ast, options)
  }
</code></pre>
<p>这其中的optimize函数，其实主要做了两件事:</p>
<ul>
<li>标记静态&amp;非静态节点</li>
<li>标记静态根结点  </li>
</ul>
<pre><code class="js">markStatic(root) <span class="comment">// 标记所有静态&amp;非静态节点</span>

markStaticRoots(root, <span class="literal">false</span>) <span class="comment">// 标记静态根节点</span>
</code></pre>
<ul>
<li>标记静态&amp;非静态结点</li>
</ul>
<p>其标记的思路是从最底层往上一步一步的去标记静态节点。先标记最底层的叶子结点，再往上标记其父节点。一旦当前节点被标记为非静态节点，那么他所有的父节点都会被标记为非静态节点。</p>
<p>每个结点是否为静态的判断依据是：isStatic(node)=true &amp;&amp; 子节点是静态节点</p>
<p>isStatic函数:</p>
<pre><code class="js"><span class="function"><span class="keyword">function</span> <span class="title">isStatic</span> (<span class="params">node: ASTNode</span>): <span class="title">boolean</span> </span>{
  <span class="keyword">if</span> (node.type === <span class="number">2</span>) { <span class="comment">// expression</span>
    <span class="keyword">return</span> <span class="literal">false</span>
  }
  <span class="keyword">if</span> (node.type === <span class="number">3</span>) { <span class="comment">// text</span>
    <span class="keyword">return</span> <span class="literal">true</span>
  }
  <span class="keyword">return</span> !!(node.pre || (
    !node.hasBindings &amp;&amp; <span class="comment">// no dynamic bindings</span>
    !node.if &amp;&amp; !node.for &amp;&amp; <span class="comment">// not v-if or v-for or v-else</span>
    !isBuiltInTag(node.tag) &amp;&amp; <span class="comment">// not a built-in</span>
    isPlatformReservedTag(node.tag) &amp;&amp; <span class="comment">// not a component</span>
    !isDirectChildOfTemplateFor(node) &amp;&amp;
    <span class="built_in">Object</span>.keys(node).every(isStaticKey) <span class="comment">// node中的所有属性  是否isStaticKey()为true</span>
  ))
}
</code></pre>
<p><em>其实就是先判断当前结点是否为表达式，是的话直接返回false，再判断是会否为纯为本，是的话直接返回true，如果都不是，再去判断是否绑定了v-for、v-if等属性。</em></p>
<ul>
<li>标记静态根结点  </li>
</ul>
<p>与标记静态&amp;非静态结点的方向正好相反，标记静态跟结点是从根结点，到叶子节点，上往下去标记的。</p>
<p>每个结点是否为静态结点的标记依据是：</p>
<p>该结点为静态结点&amp;&amp;（结点有多个子节点||有一个子节点，但是这个子节点不是纯文本）</p>
<p>以上就是标记跟结点的实现思路。</p>
<p>至此所有静态/非静态信息就标记完了。这些标记在每次vue更新DOM时都会起到很重要的优化作用，因为遇到静态节点，就知道，其自身以及子节点内容都无需更新，可直接跳过，由此很大的提高了vue的更新速度。</p>
<h4 id="c，生成render字符串"><a href="#c，生成render字符串" class="headerlink" title="c，生成render字符串"></a>c，生成render字符串</h4><p>baseCompile函数中，下面这行为生成render字符串的代码</p>
<pre><code class="js"><span class="keyword">const</span> code = generate(ast, options)  
</code></pre>
<p>文档参考：<a href="https://ustbhuangyi.github.io/vue-analysis/prepare/directory.html" target="_blank" rel="noopener">https://ustbhuangyi.github.io/vue-analysis/prepare/directory.html</a>   </p>

        
        <div id="comment-container">
        </div>
    </div>

    <div style="position:fixed;right:10px;bottom:15px;color: #999;cursor: pointer;" onclick="window.scrollTo(0,0)">回到顶部</div>
</div>
    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        
        <li>
            <a target="_blank"  href="https://github.com/fanky-c">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p style="padding-top:10px;">
        <span>/</span>
        
            
               <span><a href="http://www.fankyc.cn">fanky_c</a></span>
            
        <span>/</span>
        
            
               <span><a href="https://beian.miit.gov.cn" target="_blank">粤ICP备19149804号</a></span>
            
        <span>/</span>
        
            
               <span><a href="#">It helps SEO</a></span>
            
        <span>/</span>
        
    </p>
    
    <p style="padding-top:5px;">
        <!--<span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>-->
        Created By <a href="https://hexo.io/">Hexo</a>  Theme <a href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a>
    </p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="/js/index.js"></script>
<!-- <script async src="//cdn.jsdelivr.net/gh/sukkaw/busuanzi@2.3/bsz.pure.mini.js"></script> -->

</html>
