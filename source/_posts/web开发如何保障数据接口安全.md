---
title: web开发如何保障数据接口安全
date: 2022-07-10 14:37:52
tags:
 - web安全
 - 接口安全
---

### 接口数据安全介绍
接口数据安全主要包括：**1、数据传输过程安全、2、服务端数据识别安全、3、数据存储安全**

### 接口数据安全的方案
#### 1、数据加密，防止报文明文传输
##### 数据如何加密
1. 对称加密：  加密和解密使用相同密钥的加密算法。简单点可以使用对称加密算法（如AES）来加解密，或者哈希算法处理（如MD5）。
2. 非对称加密：非对称加密算法需要两个密钥（公开密钥和私有密钥）。公钥与私钥是成对存在的，如果用公钥对数据进行加密，只有对应的私钥才能解密。更安全的做法，就是用非对称加密算法（如RSA或者SM2），公钥加密，私钥解密。

##### https加密过程
<img src="/img/https.png" style="max-width:95%" />

1. 客户端发起Https请求，连接到服务器的443端口。
1. 服务器必须要有一套数字证书（证书内容有公钥、证书颁发机构、失效日期等）。
1. 服务器将自己的数字证书发送给客户端（公钥在证书里面，私钥由服务器持有）。
1. 客户端收到数字证书之后，会验证证书的合法性。如果证书验证通过，就会生成一个随机的对称密钥，用证书的公钥加密。
1. 客户端将公钥加密后的密钥发送到服务器。
1. 服务器接收到客户端发来的密文密钥之后，用自己之前保留的私钥对其进行非对称解密，解密之后就得到客户端的密钥，然后用客户端密钥对返回数据进行对称加密，酱紫传输的数据都是密文啦。
1. 服务器将加密后的密文返回到客户端。
1. 客户端收到后，用自己的密钥对其进行对称解密，得到服务器返回的数据。

##### 日常业务中敏感度高的接口（登录、注册、付款接口）
日常业务呢，数据传输加密这块的话，用https就可以啦，如果安全性要求较高的，比如登陆注册这些，需要传输密码的，密码就可以使用RSA等非对称加密算法，对密码加密。如果你的业务，安全性要求很高，你可以模拟https这个流程，对报文，再做一次加解密
#### 2、数据加签和验签

##### a、什么是加签验签呢
1. **数据加签**
<img src="/img/https1.png" style="max-width:95%" />

数据加签：用Hash算法（如MD5，或者SHA-256）把原始请求参数生成报文摘要，然后用私钥对这个摘要进行加密，就得到这个报文对应的数字签名sign（这个过程就是加签）。通常来说呢，请求方会把数字签名和报文原文一并发送给接收方。

1. **数据验签**
<img src="/img/https2.png" style="max-width:95%" />

接收方拿到原始报文和数字签名（sign）后，用同一个Hash算法(比如都用MD5)从报文中生成摘要A。另外，用对方提供的公钥对数字签名进行解密，得到摘要B，对比A和B是否相同，就可以得知报文有没有被篡改过。

>其实加签，我的理解的话，就是把请求参数，按照一定规则，利用hash算法+加密算法生成一个唯一标签sign。验签的话，就是把请求参数按照相同的规则处理，再用相同的hash算法，和对应的密钥解密处理，以对比这个签名是否一致
##### b、有了https等加密数据，为什么还需要加签验签
数据在传输过程中被加密了，理论上，即使被抓包，数据也不会被篡改。[但是https不是绝对安全的哦](https://mp.weixin.qq.com/s?__biz=Mzg3NzU5NTIwNg==&mid=2247494171&idx=1&sn=80479acae752311581258015faa41673&scene=21#wechat_redirect)，还有一个点：https加密的部分只是在外网，然后有很多服务是内网相互跳转的，加签也可以在这里保证不被中间人篡改，所以一般转账类安全性要求高的接口开发，都需要加签验签


#### 3、token授权认证机制
日常开发中，我们的网站或者APP，都是需要用户登录的。那么如果是非登录接口，是如何确保安全，如何确认用户身份的呢？可以使用token授权机制。

##### a、token的授权认证方案
用户在客户端输入用户名和密码，点击登录后，服务器会校验密码成功，会给客户端返回一个唯一值token，并将token以键值对的形式存放在缓存（一般是Redis）中。后续客户端对需要授权模块的所有操作都要带上这个token，服务器端接收到请求后，先进行token验证，如果token存在，才表明是合法请求
<img src="/img/token.png" style="max-width:95%" />

1. 用户输入用户名和密码，发起登录请求
1. 服务端校验密码，如果校验通过，生成一个全局唯一的token。
1. 将token存储在redis中，其中key是token，value是userId或者是用户信息，设置一个过期时间。
1. 把这个token返回给客户端
1. 用户发起其他业务请求时，需要带上这个token
1. 后台服务会统一拦截接口请求，进行token有效性校验，并从中获取用户信息，供后续业务逻辑使用。如果token不存在，说明请求无效。

##### b、如何保证token的安全
1. token设置合理的有效期
2. 使用https协议
3. token可以再次加密
4. 如果访问的是敏感信息，单纯加token是不够的，通常会再配置白名单

#### 4、时间戳timestamp超时机制
数据是很容易抓包的，假设我们用了https和加签，即使中间人抓到了数据报文，它也看不到真实数据。但是有些不法者，他根本不关心真实的数据，而是直接拿到抓取的数据包，进行恶意请求（比如DOS攻击），以搞垮你的系统。

我们可以引入时间戳超时机制，来保证接口安全。就是：用户每次请求都带上当前时间的时间戳timestamp，服务端接收到timestamp后，解密，验签通过后，与服务器当前时间进行比对，如果时间差大于一定时间 (比如3分钟)，则认为该请求无效。

#### 5、时间戳timestamp+nonce方案防止重放攻击
时间戳超时机制也是有漏洞的，如果是在时间差内，黑客进行的重放攻击，那就不好使了。可以使用timestamp+nonce方案。

nonce指唯一的随机字符串，用来标识每个被签名的请求。我们可以将每次请求的nonce参数存储到一个“set集合”中，或者可以json格式存储到数据库或缓存中。每次处理HTTP请求时，首先判断该请求的nonce参数是否在该“集合”中，如果存在则认为是非法请求。

然而对服务器来说，永久保存nonce的代价是非常大的。可以结合timestamp来优化。因为timstamp参数对于超过3min的请求，都认为非法请求，所以我们只需要存储3min的nonce参数的“集合”即可。

#### 6、限流机制
如果用户本来就是就是真实用户，他恶意频繁调用接口，想搞垮你的系统呢？这种情况就需要接入限流了。

常用的限流算法有令牌桶和漏桶算法。大家可以看下我的这篇文章[四种限流](https://mp.weixin.qq.com/s?__biz=Mzg3NzU5NTIwNg==&mid=2247490393&idx=1&sn=98189caa486406f8fa94d84ba0667604&chksm=cf21c470f8564d665ce04ccb9dc7502633246da87a0541b07ba4ac99423b28ce544cdd6c036b&token=162724582&lang=zh_CN&scene=21#wechat_redirect)
#### 7、黑名单机制
#### 8、白名单机制
#### 9、数据脱敏掩
对于密码，或者手机号、身份证这些敏感信息，一般都需要脱敏掩码再展示的，如果是密码，还需要加密再保存到数据库。

对于手机号、身份证信息这些，日常开发中，在日志排查时，看到的都应该是掩码的。目的就是尽量不泄漏这些用户信息，虽然能看日志的只是开发和运维，但是还是需要防一下，做掩码处理。

对于密码保存到数据库，我们肯定不能直接明文保存。最简单的也需要MD5处理一下再保存，Spring Security中的 BCryptPasswordEncoder也可以，它的底层是采用SHA-256 +随机盐+密钥对密码进行加密，而SHA和MD系列是一样的，都是hash摘要类的算法
#### 10、数据参数一些合法性校验(前后端都必须做)
接口数据的安全性保证，还需要我们的系统，有个数据合法性校验，简单来说就是参数校验，比如身份证长度，手机号长度，是否是数字等等。


<br />
[文章来源](https://mp.weixin.qq.com/s/xcKXtB6Ck-phhua2fY4aYw)